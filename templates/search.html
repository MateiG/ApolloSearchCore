<!DOCTYPE html>
<html>

<head>
    <title>Apollo Search</title>
    <style>
        body {
            height: 100vh;
            display: flex;
            margin: 0;
            padding: 0;
        }

        #pdf-container {
            flex: 1;
            overflow-y: scroll;
        }

        canvas {
            display: block;
            margin: 10px auto;
            border: 1px solid black;
            height: 100%;
            width: auto;
        }

        #search-container {
            display: flex;
            flex: 1;
            flex-direction: column;
            padding: 20px;
            background-color: #f1f1f1;
        }

        #search-input {
            padding: 10px;
            margin-bottom: 20px;
            box-sizing: border-box;
            font-size: 16px;
        }

        #insight-box {
            flex: none;
            height: auto;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            overflow: auto;
            font-family: sans-serif;
            font-size: 16px;
        }

        #insight-box p {
            padding: 0;
            margin: 0;
            font-family: sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: #5e5e5e;
        }

        #results-list {
            height: 100%;
            padding: 0;
            margin: 0;
            border: 1px solid #ddd;
            overflow: auto;
            list-style: none;
            box-sizing: border-box;
        }

        #results-list li {
            padding: 10px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            font-family: sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: #5e5e5e;
            cursor: pointer;
            text-decoration: none;
        }

        #results-list li:hover {
            text-decoration: underline;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.min.js"
        integrity="sha512-FbzTWNUXsD1HkMnfODpqj77B8pWe5eG9MaVtaUyZQGe8FaeQg1sNKtwMWk9USkHFu3ub8dg5PSE24s4JJpJQcQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</head>

<body>
    <div id="pdf-container">
    </div>

    <div id="search-container">
        <input type="text" id="search-input" placeholder="Search" />
        <div id="insight-box">
            <p>Insights are generated after searching</p>
        </div>
        <ol id="results-list">
            <li>Results will appear here</li>
        </ol>
    </div>

    <script>
        // Load and render the PDF
        const container = document.getElementById('pdf-container');
        var pdfInstance;

        var highlightedPage;

        pdfjsLib.getDocument('{{ pdf_path }}').promise.then(pdf => {
            pdfInstance = pdf;
            for (let pageNumber = 1; pageNumber <= pdf.numPages; pageNumber++) {
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                renderPage(pageNumber, canvas);
            }
        });

        function renderPage(pageNumber, canvas) {
            return new Promise((resolve, reject) => {
                pdfInstance.getPage(pageNumber).then(page => {
                    const context = canvas.getContext('2d');

                    const viewport = page.getViewport({ scale: 1 });
                    const scale = container.clientHeight / viewport.height;

                    const scaledViewport = page.getViewport({ scale });
                    canvas.width = scaledViewport.width;
                    canvas.height = scaledViewport.height;

                    page.render({ canvasContext: context, viewport }).promise.then(function () {
                        resolve();
                    });
                });
            });
        }

        async function highlightRegion(pageNumber, x, y, width, height) {
            await clearHighlight();

            const canvas = container.querySelectorAll('canvas')[pageNumber - 1];
            const context = canvas.getContext('2d');

            context.fillStyle = 'rgba(255, 255, 0, 0.3)';
            context.fillRect(x, y, width, height);
            canvas.scrollIntoView();

            highlightedPage = pageNumber;
        }

        async function clearHighlight() {
            if (highlightedPage) {
                const canvas = container.querySelectorAll('canvas')[highlightedPage - 1];
                await renderPage(highlightedPage, canvas);
                highlightedPage = null;
            }
        }
    </script>

    <script>
        const insightBox = document.getElementById('insight-box');
        const resultList = document.getElementById('results-list');
        const searchInput = document.getElementById('search-input');

        searchInput.addEventListener('keyup', function (event) {
            if (event.keyCode === 13) {
                const searchTerm = searchInput.value.trim();
                if (searchTerm !== '') {
                    reset();
                    search(searchTerm);
                }
            }
        });

        function reset() {
            insightBox.innerHTML = '';
            resultList.innerHTML = '';

            const paragraph = document.createElement('p');
            paragraph.textContent = 'Generating...';
            insightBox.appendChild(paragraph);

            const listItem = document.createElement('li');
            listItem.textContent = 'Searching...';
            resultList.appendChild(listItem);
        }

        function search(query) {
            const params = new URLSearchParams({
                file_id: "{{ file_id }}",
                query: query
            });

            fetch(`/query?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    resultList.innerHTML = '';

                    data['results'].forEach(doc => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = boldSubstring(doc['text'], doc['h_start'], doc['h_end']);
                        var searchTerm = doc['text'].substring(doc['h_start'], doc['h_start'] + 10);
                        listItem.addEventListener("click", function () {
                            highlightRegion(doc['page'], doc['box'][0], doc['box'][1], doc['box'][2], doc['box'][3])
                        });

                        resultList.appendChild(listItem);
                    });

                    const docIDs = data['results'].map(result => result.id);
                    get_insight(query, docIDs)
                })
                .catch(error => {
                    console.error(error);
                });
        }

        function get_insight(query, docIDs) {
            const payload = {
                file_id: "{{ file_id }}",
                query: query,
                documents: docIDs
            };

            fetch('/insight', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            }).then(response => response.json())
                .then(data => {
                    insightBox.innerHTML = '';

                    const paragraph = document.createElement('p');
                    paragraph.textContent = data['prediction'];
                    insightBox.appendChild(paragraph);
                })
                .catch(error => {
                    console.log(error);
                });
        }

        function scrollToResult(page, x_pixel, y_pixel, term) {
            // if (adobeViewer) {
            //     adobeViewer.getAPIs().then(apis => {
            //         // console.log(term)
            //         // apis.search(term)
            //         //     .then(searchObject => console.log(searchObject))
            //         //     .catch(error => console.log(error));
            //         apis.gotoLocation(page, x_pixel, y_pixel)
            //             .then(() => console.log("Success"))
            //             .catch(error => console.log(error));
            //     });
            // } else {
            //     console.log('adobeViewer not ready');
            // }
            // console.log('scroll to', page, x_pixel, y_pixel);

        }

        function boldSubstring(str, startIndex, endIndex) {
            if (startIndex < 0 || endIndex > str.length || startIndex >= endIndex) {
                return str;
            }
            return `${str.substring(0, startIndex)}<b>${str.substring(startIndex, endIndex)}</b>${str.substring(endIndex)}`;
        }
    </script>
</body>

</html>